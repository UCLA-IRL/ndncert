# DNS Challenge Specification

## Overview

The DNS Challenge allows certificate requesters to prove domain ownership by creating a DNS TXT record containing a challenge token. This challenge is suitable for domain validation scenarios where the requester has administrative control over the domain's DNS configuration.

## Challenge Flow

### Step 1: Challenge Initiation

The requester sends a CHALLENGE Interest with the domain name they want to validate:

**Interest Name:** `<CA-prefix>/CA/CHALLENGE/<request-id>`

**Interest Parameters (encrypted):**
```
SelectedChallenge: "dns"
ParameterKey: "domain"
ParameterValue: <domain-name>
```

**Example:**
```
SelectedChallenge: "dns"
ParameterKey: "domain" 
ParameterValue: "example.org"
```

### Step 2: Challenge Setup Response

The CA validates the domain name format and generates a unique challenge token. The CA responds with:

**Response Status:** `CHALLENGE`
**Challenge Status:** `need-record`

**Response Parameters (encrypted):**
```
Status: CHALLENGE
ChallengeStatus: "need-record"  
RemainingTries: <number>
RemainingTime: <seconds>
ParameterKey: "record-name"
ParameterValue: "_ndncert-challenge.<domain-name>"
ParameterKey: "expected-value"
ParameterValue: <challenge-token>
```

Where:
- `<challenge-token>` = SHA256(generated-token + "." + requester-key-hash)
- `<requester-key-hash>` = SHA256 of the requester's public key

**Example:**
```
Status: CHALLENGE
ChallengeStatus: "need-record"
RemainingTries: 3
RemainingTime: 3600
ParameterKey: "record-name" 
ParameterValue: "_ndncert-challenge.example.org"
ParameterKey: "expected-value"
ParameterValue: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
```

### Step 3: DNS Record Creation

The requester must create a DNS TXT record:

**DNS Record Details:**
- **Record Name:** `_ndncert-challenge.<domain-name>`
- **Record Type:** TXT
- **Record Value:** `<challenge-token>` (from Step 2)
- **TTL:** Any reasonable value (e.g., 300 seconds)

**Example DNS Configuration:**
```
_ndncert-challenge.example.org. IN TXT "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
```

### Step 4: Confirmation Request

After creating the DNS record, the requester sends a confirmation:

**Interest Name:** `<CA-prefix>/CA/CHALLENGE/<request-id>`

**Interest Parameters (encrypted):**
```
SelectedChallenge: "dns"
ParameterKey: "confirmation"
ParameterValue: "ready"
```

### Step 5: Validation Response

The CA performs DNS verification by querying the TXT record and responds with:

**Success Case:**
```
Status: SUCCESS
IssuedCertName: <certificate-name>
ForwardingHint: <forwarding-hint>
```

**Failure Case (verification failed):**
```
Status: CHALLENGE
ChallengeStatus: "wrong-record"
RemainingTries: <decremented-number>
RemainingTime: <remaining-seconds>
```

**Retry Exhausted:**
```
Status: FAILURE
ErrorCode: OUT_OF_TRIES
ErrorInfo: "DNS verification failed. No tries remaining."
```

## Challenge Parameters

### Supported Parameters

| Parameter | Direction | Required | Description |
|-----------|-----------|----------|-------------|
| `domain` | Client→CA | Yes | Domain name to validate (Step 1) |
| `confirmation` | Client→CA | Yes | Must be "ready" (Step 4) |
| `record-name` | CA→Client | Yes | DNS record name to create (Step 2) |
| `expected-value` | CA→Client | Yes | DNS record value to set (Step 2) |

### Domain Name Validation

The CA validates domain names using the following criteria:
- Length: 1-253 characters
- Format: RFC 1123 compliant hostname
- Pattern: `^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$`

Invalid domain names are rejected with:
```
Status: FAILURE
ErrorCode: INVALID_PARAMETER
ErrorInfo: "Invalid domain name"
```

## DNS Record Format

### Record Name Construction
The DNS record name is constructed as: `_ndncert-challenge.<domain-name>`

**Examples:**
- Domain: `example.org` → Record: `_ndncert-challenge.example.org`
- Domain: `sub.example.com` → Record: `_ndncert-challenge.sub.example.com`

### Challenge Token Generation
The challenge token is computed as:
```
challenge-token = SHA256(random-secret + "." + SHA256(requester-public-key))
```

Where:
- `random-secret`: Cryptographically secure random string generated by CA
- `requester-public-key`: DER-encoded public key from the certificate request

## DNS Verification Process

The CA performs DNS verification by:

1. Constructing the DNS record name: `_ndncert-challenge.<domain-name>`
2. Querying DNS for TXT records at that name
3. Comparing each TXT record value against the expected challenge token
4. Accepting the challenge if any TXT record matches exactly

### DNS Query Details
- **Query Type:** TXT
- **Query Class:** IN
- **Timeout:** Implementation-defined (typically 10-30 seconds)
- **Retries:** Implementation-defined (typically 2-3 attempts)

## Security Considerations

### Challenge Token Security
- Tokens MUST be cryptographically random
- Tokens MUST include the requester's key hash to prevent replay attacks
- Tokens MUST be unique per request

### DNS Security
- CAs SHOULD perform DNS queries from multiple vantage points
- CAs SHOULD implement rate limiting to prevent abuse
- CAs SHOULD validate DNS responses against known good resolvers

### Timing Considerations
- Challenge lifetime: Typically 1 hour (3600 seconds)
- DNS propagation: Allow sufficient time for DNS propagation (recommended: 5+ minutes)
- Retry limits: Typically 3-5 attempts to account for DNS propagation delays

## Error Handling

### Common Error Scenarios

| Scenario | Status | Error Code | Error Info |
|----------|---------|------------|------------|
| Invalid domain format | FAILURE | INVALID_PARAMETER | "Invalid domain name" |
| DNS record not found | CHALLENGE | - | ChallengeStatus: "wrong-record" |
| DNS record value mismatch | CHALLENGE | - | ChallengeStatus: "wrong-record" |
| Challenge expired | FAILURE | OUT_OF_TIME | "Challenge expired" |
| Too many failed attempts | FAILURE | OUT_OF_TRIES | "DNS verification failed. No tries remaining." |

### Recovery Procedures
- For DNS propagation issues: Wait and retry
- For incorrect DNS records: Update the TXT record value and retry  
- For expired challenges: Restart the certificate request process

## Implementation Notes

### CA Implementation Requirements
- MUST validate domain name format before generating challenges
- MUST perform actual DNS queries (not cached lookups)
- SHOULD implement proper DNS resolution with timeout handling
- SHOULD log DNS verification attempts for debugging

### Client Implementation Requirements  
- MUST display clear DNS record creation instructions
- SHOULD validate user input for domain names
- SHOULD provide examples of DNS record configuration
- SHOULD handle retry scenarios gracefully

### DNS Provider Compatibility
The challenge works with any DNS provider that supports:
- TXT record creation
- Standard DNS propagation (typically within 5-15 minutes)
- Public DNS resolution

Common compatible providers: Route53, Cloudflare, Google Domains, Namecheap, etc.